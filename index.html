<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beastmen Brayherds Army Builder - Homebrew Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #2c1810 0%, #4a2c1a 100%);
        color: #f5e6d3;
        padding: 20px;
        min-height: 100vh;
    }
    
    .container {
        max-width: 1600px;
        margin: 0 auto;
    }
    
    header {
        text-align: center;
        padding: 30px 20px;
        background: rgba(0,0,0,0.3);
        border-radius: 10px;
        margin-bottom: 30px;
        border: 2px solid #8b4513;
    }
    
    h1 {
        font-size: 2.5em;
        color: #d4a574;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        margin-bottom: 10px;
    }
    
    .subtitle {
        color: #a67c52;
        font-size: 1.1em;
    }
    
    .main-grid {
        display: grid;
        grid-template-columns: 350px 1fr 350px;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    @media (max-width: 1400px) {
        .main-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .panel {
        background: rgba(20, 10, 5, 0.8);
        border: 2px solid #8b4513;
        border-radius: 10px;
        padding: 20px;
    }
    
    .panel h2 {
        color: #d4a574;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #8b4513;
        font-size: 1.5em;
    }
    
    .category-section {
        margin-bottom: 20px;
    }
    
    .category-header {
        background: #8b4513;
        color: #fff;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .category-header:hover {
        background: #a0522d;
    }
    
    .unit-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .unit-item {
        background: rgba(139, 69, 19, 0.2);
        padding: 12px;
        border-radius: 5px;
        border: 1px solid #8b4513;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .unit-item:hover {
        background: rgba(139, 69, 19, 0.4);
        border-color: #d4a574;
        transform: translateX(5px);
    }
    
    .unit-name {
        font-weight: bold;
        color: #d4a574;
        margin-bottom: 5px;
    }
    
    .unit-points {
        color: #a67c52;
        font-size: 0.9em;
    }
    
    .army-unit {
        background: rgba(139, 69, 19, 0.3);
        border: 2px solid #8b4513;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .unit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .unit-title {
        font-size: 1.2em;
        font-weight: bold;
        color: #d4a574;
    }
    
    .unit-cost {
        font-size: 1.1em;
        color: #ffd700;
    }
    
    .unit-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }
    
    .control-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .control-label {
        color: #a67c52;
        font-size: 0.9em;
    }
    
    .number-input {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    button {
        background: #8b4513;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 0.9em;
    }
    
    button:hover {
        background: #a0522d;
    }
    
    button:active {
        background: #6b3410;
    }
    
    .btn-danger {
        background: #8b0000;
    }
    
    .btn-danger:hover {
        background: #a00000;
    }
    
    input[type="number"] {
        width: 60px;
        padding: 8px;
        background: rgba(0,0,0,0.5);
        border: 1px solid #8b4513;
        border-radius: 5px;
        color: #f5e6d3;
        text-align: center;
    }
    
    select {
        padding: 8px;
        background: rgba(0,0,0,0.5);
        border: 1px solid #8b4513;
        border-radius: 5px;
        color: #f5e6d3;
        width: 100%;
    }
    
    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 5px;
    }
    
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
    }
    
    input[type="checkbox"] {
        cursor: pointer;
    }
    
    .summary-section {
        background: rgba(139, 69, 19, 0.2);
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(139, 69, 19, 0.3);
    }
    
    .summary-row:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 1.2em;
        color: #ffd700;
        padding-top: 15px;
        margin-top: 10px;
        border-top: 2px solid #8b4513;
    }
    
    .special-rules {
        background: rgba(0,0,0,0.3);
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 0.9em;
    }
    
    .special-rules-title {
        color: #d4a574;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .rule-tag {
        display: inline-block;
        background: rgba(139, 69, 19, 0.5);
        padding: 3px 8px;
        border-radius: 3px;
        margin: 2px;
        font-size: 0.85em;
        color: #f5e6d3;
        position: relative;
        cursor: help;
    }
    
    .rule-tag:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.95);
        color: #f5e6d3;
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 0.9em;
        white-space: nowrap;
        z-index: 1000;
        border: 1px solid #8b4513;
        margin-bottom: 5px;
    }
    
    .export-section {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    
    .export-section button {
        flex: 1;
    }
    
    .per-model-equipment {
        background: rgba(0,0,0,0.3);
        padding: 10px;
        margin-top: 10px;
        border-radius: 5px;
    }
    
    .per-model-title {
        color: #d4a574;
        font-weight: bold;
        margin-bottom: 8px;
        font-size: 0.9em;
    }
    
    .model-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
        font-size: 0.85em;
    }
    
    .model-number {
        color: #a67c52;
        min-width: 60px;
    }
    
    .model-equipment {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    
    .gifts-section {
        background: rgba(139, 69, 19, 0.2);
        padding: 12px;
        border-radius: 5px;
        margin-top: 10px;
    }
    
    .gifts-title {
        color: #d4a574;
        font-weight: bold;
        margin-bottom: 8px;
    }
    
    .gift-warning {
        color: #ff6b6b;
        font-size: 0.85em;
        font-style: italic;
        margin-top: 5px;
    }
    
    .magic-budget {
        background: rgba(139, 69, 19, 0.2);
        padding: 10px;
        border-radius: 5px;
        margin-top: 8px;
    }
    
    .budget-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.9em;
        margin-bottom: 5px;
    }
    
    .budget-remaining {
        color: #90ee90;
    }
    
    .budget-exceeded {
        color: #ff6b6b;
    }
    
    .formation-selector {
        display: flex;
        gap: 10px;
        margin-top: 5px;
    }
    
    .formation-option {
        flex: 1;
        padding: 8px;
        background: rgba(139, 69, 19, 0.3);
        border: 2px solid #8b4513;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
    }
    
    .formation-option:hover {
        background: rgba(139, 69, 19, 0.5);
    }
    
    .formation-option.selected {
        background: rgba(139, 69, 19, 0.7);
        border-color: #d4a574;
    }
</style>
```

</head>
<body>
    <div class="container">
        <header>
            <h1>Beastmen Brayherds Army Builder</h1>
            <div class="subtitle">Homebrew Edition - Warhammer Fantasy Battles</div>
        </header>

```
    <div class="main-grid">
        <div class="panel">
            <h2>Available Units</h2>
            
            <div class="category-section">
                <div class="category-header" onclick="toggleCategory('lords')">
                    <span>LORDS</span>
                    <span id="lords-toggle">▼</span>
                </div>
                <div id="lords-list" class="unit-list"></div>
            </div>
            
            <div class="category-section">
                <div class="category-header" onclick="toggleCategory('heroes')">
                    <span>HEROES</span>
                    <span id="heroes-toggle">▼</span>
                </div>
                <div id="heroes-list" class="unit-list"></div>
            </div>
            
            <div class="category-section">
                <div class="category-header" onclick="toggleCategory('core')">
                    <span>CORE</span>
                    <span id="core-toggle">▼</span>
                </div>
                <div id="core-list" class="unit-list"></div>
            </div>
            
            <div class="category-section">
                <div class="category-header" onclick="toggleCategory('special')">
                    <span>SPECIAL</span>
                    <span id="special-toggle">▼</span>
                </div>
                <div id="special-list" class="unit-list"></div>
            </div>
            
            <div class="category-section">
                <div class="category-header" onclick="toggleCategory('rare')">
                    <span>RARE</span>
                    <span id="rare-toggle">▼</span>
                </div>
                <div id="rare-list" class="unit-list"></div>
            </div>
        </div>
        
        <div class="panel">
            <h2>Your Army</h2>
            <div id="army-list">
                <p style="text-align: center; color: #a67c52; padding: 40px;">
                    Click units from the left panel to add them to your army
                </p>
            </div>
        </div>
        
        <div class="panel">
            <h2>Army Summary</h2>
            
            <div class="summary-section">
                <div class="summary-row">
                    <span>Lords:</span>
                    <span id="lords-points">0 pts</span>
                </div>
                <div class="summary-row">
                    <span>Heroes:</span>
                    <span id="heroes-points">0 pts</span>
                </div>
                <div class="summary-row">
                    <span>Core:</span>
                    <span id="core-points">0 pts</span>
                </div>
                <div class="summary-row">
                    <span>Special:</span>
                    <span id="special-points">0 pts</span>
                </div>
                <div class="summary-row">
                    <span>Rare:</span>
                    <span id="rare-points">0 pts</span>
                </div>
                <div class="summary-row">
                    <span>TOTAL:</span>
                    <span id="total-points">0 pts</span>
                </div>
            </div>
            
            <div id="gifts-used" class="summary-section" style="display:none;">
                <h3 style="color: #d4a574; margin-bottom: 10px;">Gifts of Chaos Used</h3>
                <div id="gifts-list" style="font-size: 0.9em;"></div>
            </div>
            
            <div class="export-section">
                <button onclick="exportList()">Export List</button>
                <button onclick="clearArmy()" class="btn-danger">Clear Army</button>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                <h3 style="color: #d4a574; margin-bottom: 10px;">Homebrew Changes</h3>
                <ul style="font-size: 0.85em; line-height: 1.6; color: #a67c52; list-style-position: inside;">
                    <li>Primal Fury: Pass LD for Hatred, doubles = Frenzy</li>
                    <li>Bestial Charge: Re-roll one charge die</li>
                    <li>Beastmen Ambush: +1 to Ambusher rolls</li>
                    <li>Crushing Blows: +1 AP on melee attacks</li>
                    <li>Razor Tusks: AP-1 when charging</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    const SPECIAL_RULE_TOOLTIPS = {
        'Primal Fury': 'Each round of combat: Pass LD test = Hatred. Roll doubles = Hatred + Frenzy',
        'Bestial Charge': 'When charging, re-roll one of the charge dice',
        'Beastmen Ambush': 'Has Ambushers + add +1 to rolls for entering table',
        'Crushing Blows': 'Increase AP of all melee attacks by 1 (AP/ → AP-1, AP-1 → AP-2, etc)',
        'Bloodgreed': 'Gains +1 Attack for each unsaved wound caused in previous round',
        'Drunken': 'Each Strategy Phase roll D6: 1-2 = Stupidity, 3-4 = Furious Charge, 5-6 = Stubborn',
        'Despoilers': 'Each enemy standard captured/killed in combat = +1 future Combat Resolution',
        'Razor Tusks (AP-1 when charging)': 'When charging, tusks attacks and Impact Hits become AP-1',
        'Warband': 'Can have multiple units with same name in army',
        'Expendable': 'Friendly units ignore panic from this unit fleeing/destroyed',
        'Fast Cavalry': 'Can fire 360°, reform after moving, flee and rally freely',
        'Skirmishers': 'Always in Open Order, 360° LOS, -1 To Hit from shooting',
        'First Charge': 'Lance weapons lose +2S after first round of combat',
        'Close Order': 'Ranks tightly packed, grants rank bonus',
        'Mark of Chaos Undivided': 'Re-roll failed Fear, Panic or Terror tests',
        'Fear': 'Enemy must pass Fear test or suffer -1 WS, cannot pursue if flee',
        'Terror': 'Enemy must pass Terror test or flee. Fear immune automatically pass',
        'Large Target': 'Can be shot at even if not closest target',
        'Stubborn': 'Use unmodified Leadership for Break tests',
        'Unbreakable': 'Never takes Break tests, automatically passes',
        'Random Movement (2D6)': 'Roll 2D6 for movement instead of fixed value',
        'Random Attacks (D6+1)': 'Roll D6+1 for attacks each combat phase',
        'Random Attacks (D6+3)': 'Roll D6+3 for attacks each combat phase',
        'Fly (9)': 'Can fly with 9" movement, ignores terrain',
        'Impact Hits (1)': 'Causes 1 automatic S hit when charging',
        'Impact Hits (D3)': 'Causes D3 automatic S hits when charging',
        'Impact Hits (D6+1)': 'Causes D6+1 automatic S hits when charging',
        'Impact Hits (D6+2)': 'Causes D6+2 automatic S hits when charging',
        'Crown of Antlers (re-roll Impact Hits)': 'Can re-roll the number of Impact Hits',
        'Petrifying Gaze (auto-hit I test, Multiple Wounds D3)': 'Auto-hit that causes I test or D3 wounds (no armor save, Magical)',
        'Stony Stare (fail = D3 wounds)': 'If I test failed, suffer D3 wounds (no armor save)',
        'Ghostsight': 'Does not affect models with Regeneration save',
        'Soul-Eater (24")': 'Special ranged ability with 24" range',
        'Swallow Whole': 'Can instantly kill models on successful wound',
        'Maddening Aura (12")': 'At start of Magic phase: enemies within 12" take LD test, lose wounds = failure margin',
        'Spurting Bile-blood': 'Enemies in base contact suffer hits when this model loses wounds',
        'Ensorcelled Weapons (all melee)': 'All melee weapons have Magical Attacks',
        'Immune to Lightning': 'Cannot be harmed by lightning-based attacks',
        'Stupidity': 'Must pass LD test or can only move directly forward',
        'Regeneration (4+)': 'After suffering wound, roll 4+ to ignore it',
        'Regeneration (5+)': 'After suffering wound, roll 5+ to ignore it',
        'Giant Special Attacks': 'Special attack table for Giants',
        'Armour Bane (1)': 'Improves AP by 1 when attacking armoured targets',
        'Wizard Level 1': 'Level 1 Wizard, knows 1 spell',
        'Wizard Level 2': 'Level 2 Wizard, knows 2 spells',
        'Wizard Level 3': 'Level 3 Wizard, knows 3 spells',
        'Counter Charge': 'Can declare charge when charged (Mark of Khorne)',
        'Furious Charge': 'Gain +1 S on turn they charge (Mark of Khorne)',
        'Magic Resistance (-1)': 'Enemy spells suffer -1 to cast against this unit (Mark of Tzeentch)',
        'Ward (6+)': '6+ save after all other saves (Mark of Tzeentch)',
        'Poisoned Attacks': 'Always wound on 6 To Hit regardless of T (Mark of Nurgle)',
        'Immune to Psychology': 'Immune to Fear, Terror, Panic (Mark of Slaanesh)'
    };

    const UNIT_DATA = {
        lords: {
            'Beastlord': {
                points: 135,
                stats: 'M5 WS7 BS3 S5 T5 W3 I5 A4 Ld9',
                equipment: ['Hand weapon', 'Heavy armour'],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Beastmen Ambush', 'Mark of Chaos Undivided', 'Crushing Blows'],
                options: {
                    weapons: [
                        { name: 'Additional hand weapon', cost: 3 },
                        { name: 'Great weapon', cost: 4 },
                        { name: 'Cavalry spear', cost: 3 }
                    ],
                    armor: [
                        { name: 'Shield', cost: 1 },
                        { name: 'Light armour', cost: 2 }
                    ],
                    mounts: [
                        { name: 'Tuskgor chariot', cost: 90 },
                        { name: 'Razorgor chariot', cost: 120 }
                    ],
                    marks: true,
                    gifts: true,
                    magicItems: 100
                }
            },
            'Great Bray-Shaman': {
                points: 135,
                stats: 'M5 WS4 BS3 S4 T4 W3 I4 A2 Ld8',
                equipment: ['Hand weapon'],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Beastmen Ambush', 'Mark of Chaos Undivided', 'Wizard Level 3'],
                options: {
                    weapons: [{ name: 'Additional hand weapon', cost: 3 }],
                    mounts: [
                        { name: 'Tuskgor chariot', cost: 90 },
                        { name: 'Razorgor chariot', cost: 120 }
                    ],
                    marks: true,
                    gifts: true,
                    arcaneItems: 100
                }
            },
            'Doombull': {
                points: 225,
                stats: 'M6 WS6 BS3 S6 T5 W4 I4 A5 Ld8',
                equipment: ['Hand weapon', 'Heavy armour'],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Mark of Chaos Undivided', 'Bloodgreed', 'Crushing Blows', 'Fear', 'Impact Hits (1)'],
                options: {
                    weapons: [
                        { name: 'Additional hand weapon', cost: 3 },
                        { name: 'Great weapon', cost: 4 }
                    ],
                    armor: [
                        { name: 'Shield', cost: 1 },
                        { name: 'Light armour', cost: 2 }
                    ],
                    marks: true,
                    gifts: true,
                    magicItems: 100
                }
            }
        },
        heroes: {
            'Wargor': {
                points: 50,
                stats: 'M5 WS5 BS3 S4 T4 W2 I4 A3 Ld7',
                equipment: ['Hand weapon', 'Heavy armour'],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Beastmen Ambush', 'Mark of Chaos Undivided'],
                options: {
                    weapons: [
                        { name: 'Additional hand weapon', cost: 3 },
                        { name: 'Great weapon', cost: 4 },
                        { name: 'Cavalry spear', cost: 3 }
                    ],
                    armor: [
                        { name: 'Shield', cost: 1 },
                        { name: 'Light armour', cost: 2 }
                    ],
                    mounts: [
                        { name: 'Tuskgor chariot', cost: 90 },
                        { name: 'Razorgor chariot', cost: 120 }
                    ],
                    bsb: { name: 'Battle Standard Bearer', cost: 25 },
                    marks: true,
                    gifts: true,
                    magicItems: 50
                }
            },
            'Bray-Shaman': {
                points: 65,
                stats: 'M5 WS4 BS3 S3 T4 W2 I3 A1 Ld7',
                equipment: ['Hand weapon'],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Beastmen Ambush', 'Mark of Chaos Undivided', 'Wizard Level 1'],
                options: {
                    weapons: [{ name: 'Additional hand weapon', cost: 3 }],
                    wizardLevel: [{ name: 'Upgrade to Level 2', cost: 15 }],
                    mounts: [
                        { name: 'Tuskgor chariot', cost: 90 },
                        { name: 'Razorgor chariot', cost: 120 }
                    ],
                    marks: true,
                    gifts: true,
                    arcaneItems: 50
                }
            },
            'Gorebull': {
                points: 115,
                stats: 'M6 WS5 BS3 S5 T5 W3 I3 A4 Ld7',
                equipment: ['Hand weapon', 'Heavy armour'],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Mark of Chaos Undivided', 'Bloodgreed', 'Crushing Blows', 'Fear', 'Impact Hits (1)'],
                options: {
                    weapons: [
                        { name: 'Additional hand weapon', cost: 3 },
                        { name: 'Great weapon', cost: 4 }
                    ],
                    armor: [
                        { name: 'Shield', cost: 1 },
                        { name: 'Light armour', cost: 2 }
                    ],
                    bsb: { name: 'Battle Standard Bearer', cost: 25 },
                    marks: true,
                    gifts: true,
                    magicItems: 50
                }
            },
            'Centigor Chieftain': {
                points: 85,
                stats: 'M9 WS5 BS3 S4 T5 W2 I4 A3 Ld8',
                equipment: ['Hand weapon', 'Heavy armour'],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Mark of Chaos Undivided', 'Fast Cavalry', 'Drunken', 'Crushing Blows'],
                options: {
                    weapons: [
                        { name: 'Great weapon', cost: 4 },
                        { name: 'Cavalry spear', cost: 3 }
                    ],
                    armor: [{ name: 'Shield', cost: 1 }],
                    marks: true,
                    gifts: true,
                    magicItems: 50
                }
            }
        },
        core: {
            'Gor Herds': {
                points: 6,
                minSize: 10,
                maxSize: 50,
                stats: 'M5 WS4 BS3 S4 T4 W1 I4 A1 Ld7',
                equipment: ['Hand weapon', 'Shield'],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Beastmen Ambush', 'Mark of Chaos Undivided', 'Warband'],
                options: {
                    weapons: [
                        { name: 'Additional hand weapon', cost: 2, perModel: true },
                        { name: 'Great weapon', cost: 2, perModel: true }
                    ],
                    command: [
                        { name: 'Foe-render', cost: 10, champion: true },
                        { name: 'Musician', cost: 5 },
                        { name: 'Standard bearer', cost: 10 },
                        { name: 'True horn', cost: 5 }
                    ],
                    marks: true,
                    formation: ['Close Order', 'Open Order']
                }
            },
            'Ungor Herds': {
                points: 4,
                minSize: 10,
                maxSize: 50,
                stats: 'M5 WS3 BS3 S3 T3 W1 I3 A1 Ld6',
                equipment: ['Hand weapon'],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Beastmen Ambush', 'Mark of Chaos Undivided', 'Warband', 'Expendable'],
                options: {
                    weapons: [
                        { name: 'Throwing spear', cost: 0, perModel: true },
                        { name: 'Thrusting spear', cost: 0, perModel: true },
                        { name: 'Shortbow', cost: 0, perModel: true }
                    ],
                    command: [
                        { name: 'Half-horn', cost: 5, champion: true },
                        { name: 'Musician', cost: 5 },
                        { name: 'Standard bearer', cost: 10 }
                    ],
                    marks: true
                }
            },
            'Chaos Warhounds': {
                points: 5,
                minSize: 5,
                maxSize: 30,
                stats: 'M9 WS4 BS0 S4 T3 W1 I4 A1 Ld5',
                equipment: [],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Fast Cavalry', 'Expendable'],
                options: {
                    upgrades: [
                        { name: 'Armoured hide', cost: 1, perModel: true },
                        { name: 'Poisoned attacks', cost: 1, perModel: true },
                        { name: 'Vanguard', cost: 1, perModel: true }
                    ]
                }
            },
            'Tuskgor Chariots': {
                points: 80,
                minSize: 1,
                maxSize: 6,
                stats: 'Chariot T4 W3 / Crew M5 WS4 BS3 S4 T4 W1 I4 A1 Ld6',
                equipment: ['Hand weapon', 'Shield'],
                specialRules: ['First Charge', 'Primal Fury', 'Close Order', 'Mark of Chaos Undivided', 'Razor Tusks (AP-1 when charging)', 'Impact Hits (D6+1)', 'Warband'],
                options: {
                    command: [{ name: 'Standard bearer', cost: 10 }],
                    marks: true
                }
            }
        },
        special: {
            'Bestigor Herds': {
                points: 9,
                minSize: 10,
                maxSize: 50,
                stats: 'M5 WS5 BS3 S4 T4 W1 I4 A1 Ld7',
                equipment: ['Great weapon', 'Heavy armour'],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Mark of Chaos Undivided', 'Despoilers', 'Close Order'],
                championStats: { 'Gouge-horn': 'Ld7' },
                options: {
                    command: [
                        { name: 'Gouge-horn', cost: 6, champion: true },
                        { name: 'Musician', cost: 5 },
                        { name: 'Standard bearer', cost: 10 }
                    ],
                    marks: true
                }
            },
            'Centigor Herds': {
                points: 9,
                minSize: 5,
                maxSize: 20,
                stats: 'M9 WS4 BS3 S4 T4 W1 I3 A1 Ld6',
                equipment: ['Hand weapon'],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Mark of Chaos Undivided', 'Fast Cavalry', 'Drunken'],
                championStats: { 'Gorehoof': 'Ld6' },
                options: {
                    weapons: [
                        { name: 'Throwing axes', cost: 0, perModel: true },
                        { name: 'Javelins', cost: 0, perModel: true },
                        { name: 'Throwing spears', cost: 0, perModel: true },
                        { name: 'Cavalry spear', cost: 0, perModel: true },
                        { name: 'Great weapon', cost: 2, perModel: true }
                    ],
                    command: [
                        { name: 'Gorehoof', cost: 6, champion: true },
                        { name: 'Musician', cost: 5 },
                        { name: 'Standard bearer', cost: 10 }
                    ],
                    marks: true
                }
            },
            'Razorgor Herds': {
                points: 32,
                minSize: 1,
                maxSize: 6,
                stats: 'M7 WS4 BS0 S5 T5 W3 I3 A3 Ld6',
                equipment: [],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Razor Tusks (AP-1 when charging)', 'Armour Bane (1)', 'Crushing Blows', 'Fear'],
                options: {}
            },
            'Minotaur Herds': {
                points: 27,
                minSize: 3,
                maxSize: 20,
                stats: 'M6 WS4 BS3 S5 T5 W3 I3 A3 Ld7',
                equipment: ['Hand weapon', 'Heavy armour'],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Mark of Chaos Undivided', 'Bloodgreed', 'Crushing Blows', 'Fear', 'Impact Hits (1)'],
                options: {
                    weapons: [
                        { name: 'Additional hand weapon', cost: 3, perModel: true },
                        { name: 'Great weapon', cost: 4, perModel: true }
                    ],
                    armor: [
                        { name: 'Shield', cost: 2, perModel: true },
                        { name: 'Light armour', cost: 2, perModel: true }
                    ],
                    command: [
                        { name: 'Blood-kine', cost: 15, champion: true },
                        { name: 'Musician', cost: 10 },
                        { name: 'Standard bearer', cost: 20 }
                    ],
                    marks: true,
                    marksDouble: true
                }
            },
            'Chaos Ogres': {
                points: 25,
                minSize: 3,
                maxSize: 12,
                stats: 'M6 WS3 BS2 S4 T5 W3 I2 A3 Ld7',
                equipment: ['Hand weapon', 'Light armour'],
                specialRules: ['Mark of Chaos Undivided', 'Fear', 'Impact Hits (1)'],
                options: {
                    weapons: [
                        { name: 'Additional hand weapon', cost: 3, perModel: true },
                        { name: 'Great weapon', cost: 4, perModel: true }
                    ],
                    armor: [{ name: 'Heavy armour', cost: 2, perModel: true }],
                    command: [
                        { name: 'Crusher', cost: 15, champion: true },
                        { name: 'Musician', cost: 10 },
                        { name: 'Standard bearer', cost: 20 }
                    ],
                    marks: true,
                    marksDouble: true
                }
            },
            'Preyton': {
                points: 155,
                minSize: 1,
                maxSize: 3,
                stats: 'M6 WS5 BS0 S5 T5 W4 I4 A4 Ld7',
                equipment: [],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Fly (9)', 'Fear', 'Impact Hits (D3)', 'Crown of Antlers (re-roll Impact Hits)'],
                options: {}
            },
            'Harpies': {
                points: 9,
                minSize: 5,
                maxSize: 20,
                stats: 'M5 WS3 BS0 S3 T3 W1 I4 A2 Ld5',
                equipment: [],
                specialRules: ['Fly (9)', 'Skirmishers'],
                options: {}
            },
            'Dragon Ogres': {
                points: 39,
                minSize: 3,
                maxSize: 12,
                stats: 'M7 WS4 BS3 S5 T5 W4 I3 A4 Ld8',
                equipment: ['Hand weapon', 'Heavy armour'],
                specialRules: ['Mark of Chaos Undivided', 'Fear', 'Ensorcelled Weapons (all melee)', 'Immune to Lightning'],
                options: {
                    weapons: [
                        { name: 'Additional hand weapon', cost: 3, perModel: true },
                        { name: 'Great weapon', cost: 4, perModel: true }
                    ],
                    command: [
                        { name: 'Kholek', cost: 15, champion: true },
                        { name: 'Musician', cost: 10 },
                        { name: 'Standard bearer', cost: 20 }
                    ]
                }
            },
            'Cockatrice': {
                points: 165,
                minSize: 1,
                maxSize: 1,
                stats: 'M6 WS4 BS0 S5 T5 W4 I3 A4 Ld6',
                equipment: [],
                specialRules: ['Fly (9)', 'Terror', 'Petrifying Gaze (auto-hit I test, Multiple Wounds D3)', 'Stony Stare (fail = D3 wounds)'],
                options: {}
            }
        },
        rare: {
            'Cygor': {
                points: 210,
                minSize: 1,
                maxSize: 1,
                stats: 'M6 WS3 BS3 S6 T6 W6 I3 A4 Ld5',
                equipment: [],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Terror', 'Large Target', 'Stubborn', 'Ghostsight', 'Soul-Eater (24")'],
                options: {}
            },
            'Razorgor Chariot': {
                points: 100,
                minSize: 1,
                maxSize: 3,
                stats: 'Chariot T5 W4 / Crew M5 WS4 BS3 S4 T4 W1 I4 A1 Ld6',
                equipment: ['Hand weapon', 'Shield'],
                specialRules: ['Close Order', 'Primal Fury', 'Bestial Charge', 'Armour Bane (1)', 'Mark of Chaos Undivided', 'Razor Tusks (AP-1 when charging)', 'Impact Hits (D6+2)', 'Fear', 'First Charge', 'Crushing Blows'],
                options: {
                    marks: true
                }
            },
            'Chaos Giant': {
                points: 170,
                minSize: 1,
                maxSize: 1,
                stats: 'M6 WS3 BS3 S6 T6 W6 I3 A4 Ld10',
                equipment: [],
                specialRules: ['Terror', 'Large Target', 'Stubborn', 'Giant Special Attacks'],
                options: {
                    upgrades: [
                        { name: 'Scaly skin', cost: 5 },
                        { name: 'Regeneration (5+)', cost: 10 }
                    ]
                }
            },
            'Chaos Spawn': {
                points: 37,
                minSize: 1,
                maxSize: 6,
                stats: 'M2D6 WS3 BS0 S5 T5 W3 I2 A(D6+1) Ld10',
                equipment: [],
                specialRules: ['Fear', 'Random Movement (2D6)', 'Random Attacks (D6+1)', 'Unbreakable'],
                options: {
                    marks: true,
                    marksDouble: true
                }
            },
            'Chaos Trolls': {
                points: 22,
                minSize: 3,
                maxSize: 12,
                stats: 'M6 WS3 BS1 S5 T5 W3 I1 A3 Ld4',
                equipment: ['Troll vomit (S5)'],
                specialRules: ['Fear', 'Regeneration (4+)', 'Stupidity'],
                options: {}
            },
            'Dragon Ogre Shaggoth': {
                points: 220,
                minSize: 1,
                maxSize: 1,
                stats: 'M7 WS6 BS3 S6 T5 W6 I4 A5 Ld8',
                equipment: ['Hand weapon', 'Heavy armour'],
                specialRules: ['Mark of Chaos Undivided', 'Terror', 'Ensorcelled Weapons (all melee)', 'Immune to Lightning', 'Crushing Blows'],
                options: {
                    weapons: [
                        { name: 'Additional hand weapon', cost: 3 },
                        { name: 'Great weapon', cost: 4 }
                    ]
                }
            },
            'Ghorgon': {
                points: 230,
                minSize: 1,
                maxSize: 1,
                stats: 'M7 WS4 BS0 S6 T6 W6 I4 A5 Ld6',
                equipment: [],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Terror', 'Large Target', 'Bloodgreed', 'Swallow Whole'],
                options: {}
            },
            'Gigantic Spawn of Chaos': {
                points: 175,
                minSize: 1,
                maxSize: 1,
                stats: 'M2D6 WS3 BS0 S6 T6 W6 I2 A(D6+3) Ld10',
                equipment: [],
                specialRules: ['Terror', 'Random Movement (2D6)', 'Random Attacks (D6+3)', 'Unbreakable'],
                options: {}
            },
            'Jabberslythe': {
                points: 165,
                minSize: 1,
                maxSize: 1,
                stats: 'M7 WS4 BS0 S6 T5 W5 I4 A5 Ld5',
                equipment: [],
                specialRules: ['Primal Fury', 'Bestial Charge', 'Fly (9)', 'Terror', 'Maddening Aura (12")', 'Spurting Bile-blood'],
                options: {
                    upgrades: [
                        { name: 'Acidic vomit (S4 AP-1 Breath)', cost: 20 }
                    ]
                }
            }
        }
    };

    const MARKS_OF_CHAOS = {
        'Undivided': { cost: 0, costPerModel: 0, rules: 'Re-roll failed Fear/Panic/Terror' },
        'Tzeentch': { cost: 20, costPerModel: 2, rules: 'Magic Resistance (-1), Ward (6+)' },
        'Nurgle': { cost: 15, costPerModel: 2, rules: 'Poisoned Attacks, -1 WS to enemies in contact' },
        'Khorne': { cost: 15, costPerModel: 2, rules: 'Counter Charge, Furious Charge' },
        'Slaanesh': { cost: 10, costPerModel: 2, rules: 'Immune to Psychology, +1 MVT' }
    };

    const GIFTS_OF_CHAOS = {
        'Uncanny Senses': { cost: 5, effect: '+1 I' },
        'Gnarled Hides': { cost: 5, effect: '+1 armour save' },
        'Gouge-Tusks': { cost: 10, effect: 'Impact Hits (1) or +1 Impact' },
        'Many-Limbed Fiend': { cost: 15, effect: '+1 A (hand weapon)' },
        'Rune of the Beast Ascendant': { cost: 15, effect: '+1 Ld' },
        'Muscular Monstrosity': { cost: 20, effect: '+1 S' },
        'Crown of Horns': { cost: 20, effect: 'Stubborn (character & unit)' },
        'Pelt of Midnight': { cost: 25, effect: '-1 To Hit vs shooting' },
        'Slug-Skin': { cost: 30, effect: 'Enemy re-rolls To Hit in combat' }
    };

    let army = {
        lords: [],
        heroes: [],
        core: [],
        special: [],
        rare: []
    };

    let usedGifts = new Set();
    let nextUnitId = 1;

    function init() {
        renderUnitLists();
        updateSummary();
    }

    function renderUnitLists() {
        Object.keys(UNIT_DATA).forEach(category => {
            const listElement = document.getElementById(`${category}-list`);
            listElement.innerHTML = '';
            
            Object.entries(UNIT_DATA[category]).forEach(([name, data]) => {
                const unitDiv = document.createElement('div');
                unitDiv.className = 'unit-item';
                unitDiv.onclick = () => addUnit(category, name);
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'unit-name';
                nameDiv.textContent = name;
                
                const pointsDiv = document.createElement('div');
                pointsDiv.className = 'unit-points';
                pointsDiv.textContent = `${data.points} pts${data.minSize ? ` (min ${data.minSize})` : ''}`;
                
                unitDiv.appendChild(nameDiv);
                unitDiv.appendChild(pointsDiv);
                listElement.appendChild(unitDiv);
            });
        });
    }

    function toggleCategory(category) {
        const list = document.getElementById(`${category}-list`);
        const toggle = document.getElementById(`${category}-toggle`);
        
        if (list.style.display === 'none') {
            list.style.display = 'flex';
            toggle.textContent = '▼';
        } else {
            list.style.display = 'none';
            toggle.textContent = '▶';
        }
    }

    function addUnit(category, unitName) {
        const unitData = UNIT_DATA[category][unitName];
        const unit = {
            id: nextUnitId++,
            name: unitName,
            category: category,
            data: JSON.parse(JSON.stringify(unitData)),
            size: unitData.minSize || 1,
            options: {
                weapons: [],
                armor: [],
                command: [],
                upgrades: [],
                mark: 'Undivided',
                gifts: [],
                formation: unitData.options?.formation ? unitData.options.formation[0] : null,
                modelEquipment: {}
            }
        };
        
        // Initialize model equipment tracking
        if (unit.size > 1) {
            for (let i = 1; i <= unit.size; i++) {
                unit.options.modelEquipment[i] = { weapons: [], armor: [], upgrades: [] };
            }
        }
        
        army[category].push(unit);
        renderArmy();
        updateSummary();
    }

    function removeUnit(category, unitId) {
        const unit = army[category].find(u => u.id === unitId);
        if (unit && unit.options.gifts) {
            unit.options.gifts.forEach(gift => usedGifts.delete(gift));
        }
        army[category] = army[category].filter(u => u.id !== unitId);
        renderArmy();
        updateSummary();
    }

    function calculateUnitCost(unit) {
        let cost = unit.data.points;
        
        if (unit.size > 1) {
            cost *= unit.size;
        }
        
        // Per-model equipment
        if (unit.options.modelEquipment && Object.keys(unit.options.modelEquipment).length > 0) {
            Object.values(unit.options.modelEquipment).forEach(modelEq => {
                modelEq.weapons?.forEach(weapon => {
                    const weaponData = unit.data.options.weapons?.find(w => w.name === weapon);
                    if (weaponData) {
                        cost += weaponData.cost;
                    }
                });
                modelEq.armor?.forEach(armor => {
                    const armorData = unit.data.options.armor?.find(a => a.name === armor);
                    if (armorData) {
                        cost += armorData.cost;
                    }
                });
                modelEq.upgrades?.forEach(upgrade => {
                    const upgradeData = unit.data.options.upgrades?.find(u => u.name === upgrade);
                    if (upgradeData) {
                        cost += upgradeData.cost;
                    }
                });
            });
        }
        
        // Unit-wide equipment (characters)
        unit.options.weapons.forEach(weapon => {
            const weaponData = unit.data.options.weapons?.find(w => w.name === weapon);
            if (weaponData && !weaponData.perModel) {
                cost += weaponData.cost;
            }
        });
        
        unit.options.armor.forEach(armor => {
            const armorData = unit.data.options.armor?.find(a => a.name === armor);
            if (armorData && !armorData.perModel) {
                cost += armorData.cost;
            }
        });
        
        unit.options.command.forEach(cmd => {
            const cmdData = unit.data.options.command?.find(c => c.name === cmd);
            if (cmdData) {
                cost += cmdData.cost;
            }
        });
        
        unit.options.upgrades.forEach(upgrade => {
            const upgradeData = unit.data.options.upgrades?.find(u => u.name === upgrade);
            if (upgradeData && !upgradeData.perModel) {
                cost += upgradeData.cost;
            }
        });
        
        if (unit.options.mark && unit.options.mark !== 'Undivided') {
            const markData = MARKS_OF_CHAOS[unit.options.mark];
            if (unit.data.options.marksDouble) {
                cost += markData.cost * 2 + (markData.costPerModel * unit.size * 2);
            } else if (unit.size > 1) {
                cost += markData.costPerModel * unit.size;
            } else {
                cost += markData.cost;
            }
        }
        
        unit.options.gifts.forEach(gift => {
            cost += GIFTS_OF_CHAOS[gift].cost;
        });
        
        if (unit.options.bsb) {
            cost += unit.data.options.bsb.cost;
        }
        
        if (unit.options.wizardLevel) {
            cost += unit.data.options.wizardLevel[0].cost;
        }
        
        return cost;
    }

    function renderArmy() {
        const armyList = document.getElementById('army-list');
        armyList.innerHTML = '';
        
        let hasUnits = false;
        
        Object.entries(army).forEach(([category, units]) => {
            units.forEach(unit => {
                hasUnits = true;
                const unitDiv = document.createElement('div');
                unitDiv.className = 'army-unit';
                
                const header = document.createElement('div');
                header.className = 'unit-header';
                
                const title = document.createElement('div');
                title.className = 'unit-title';
                title.textContent = `${unit.name}${unit.size > 1 ? ` (${unit.size})` : ''}`;
                
                const cost = document.createElement('div');
                cost.className = 'unit-cost';
                cost.textContent = `${calculateUnitCost(unit)} pts`;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-danger';
                removeBtn.textContent = '✕';
                removeBtn.onclick = () => removeUnit(category, unit.id);
                
                header.appendChild(title);
                header.appendChild(cost);
                header.appendChild(removeBtn);
                
                const controls = document.createElement('div');
                controls.className = 'unit-controls';
                
                // Size control
                if (unit.data.minSize) {
                    const sizeGroup = document.createElement('div');
                    sizeGroup.className = 'control-group';
                    
                    const label = document.createElement('div');
                    label.className = 'control-label';
                    label.textContent = 'Unit Size:';
                    
                    const numberInput = document.createElement('div');
                    numberInput.className = 'number-input';
                    
                    const minusBtn = document.createElement('button');
                    minusBtn.textContent = '-';
                    minusBtn.onclick = () => {
                        if (unit.size > unit.data.minSize) {
                            delete unit.options.modelEquipment[unit.size];
                            unit.size--;
                            renderArmy();
                            updateSummary();
                        }
                    };
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.value = unit.size;
                    input.min = unit.data.minSize;
                    input.max = unit.data.maxSize;
                    input.onchange = (e) => {
                        const val = parseInt(e.target.value);
                        if (val >= unit.data.minSize && val <= unit.data.maxSize) {
                            const oldSize = unit.size;
                            unit.size = val;
                            if (val > oldSize) {
                                for (let i = oldSize + 1; i <= val; i++) {
                                    unit.options.modelEquipment[i] = { weapons: [], armor: [], upgrades: [] };
                                }
                            } else {
                                for (let i = val + 1; i <= oldSize; i++) {
                                    delete unit.options.modelEquipment[i];
                                }
                            }
                            renderArmy();
                            updateSummary();
                        } else {
                            e.target.value = unit.size;
                        }
                    };
                    
                    const plusBtn = document.createElement('button');
                    plusBtn.textContent = '+';
                    plusBtn.onclick = () => {
                        if (unit.size < unit.data.maxSize) {
                            unit.size++;
                            unit.options.modelEquipment[unit.size] = { weapons: [], armor: [], upgrades: [] };
                            renderArmy();
                            updateSummary();
                        }
                    };
                    
                    numberInput.appendChild(minusBtn);
                    numberInput.appendChild(input);
                    numberInput.appendChild(plusBtn);
                    
                    sizeGroup.appendChild(label);
                    sizeGroup.appendChild(numberInput);
                    controls.appendChild(sizeGroup);
                }
                
                // Formation selection
                if (unit.data.options?.formation) {
                    const formationGroup = document.createElement('div');
                    formationGroup.className = 'control-group';
                    
                    const label = document.createElement('div');
                    label.className = 'control-label';
                    label.textContent = 'Formation:';
                    
                    const formationSelector = document.createElement('div');
                    formationSelector.className = 'formation-selector';
                    
                    unit.data.options.formation.forEach(formation => {
                        const option = document.createElement('div');
                        option.className = 'formation-option';
                        if (unit.options.formation === formation) {
                            option.classList.add('selected');
                        }
                        option.textContent = formation;
                        option.onclick = () => {
                            unit.options.formation = formation;
                            renderArmy();
                            updateSummary();
                        };
                        formationSelector.appendChild(option);
                    });
                    
                    formationGroup.appendChild(label);
                    formationGroup.appendChild(formationSelector);
                    controls.appendChild(formationGroup);
                }
                
                // Mark of Chaos
                if (unit.data.options?.marks) {
                    const markGroup = document.createElement('div');
                    markGroup.className = 'control-group';
                    
                    const label = document.createElement('div');
                    label.className = 'control-label';
                    label.textContent = 'Mark of Chaos:';
                    
                    const select = document.createElement('select');
                    select.value = unit.options.mark;
                    select.onchange = (e) => {
                        unit.options.mark = e.target.value;
                        renderArmy();
                        updateSummary();
                    };
                    
                    Object.entries(MARKS_OF_CHAOS).forEach(([name, data]) => {
                        const option = document.createElement('option');
                        option.value = name;
                        let costText = data.cost > 0 ? ` (${data.cost}pts` : '';
                        if (data.costPerModel > 0) {
                                costText += data.cost > 0 ? ` + ${data.costPerModel}pts/model)` : ` (${data.costPerModel}pts/model)`;
                            } else if (data.cost > 0) {
                                costText += ')';
                            }
                            option.textContent = `${name}${costText}`;
                            select.appendChild(option);
                        });
                        
                        markGroup.appendChild(label);
                        markGroup.appendChild(select);
                        controls.appendChild(markGroup);
                    }
                    
                    // Gifts of Chaos
                    if (unit.data.options?.gifts) {
                        const giftsGroup = document.createElement('div');
                        giftsGroup.className = 'control-group';
                        
                        const label = document.createElement('div');
                        label.className = 'control-label';
                        label.textContent = 'Gifts of Chaos:';
                        
                        const giftsSection = document.createElement('div');
                        giftsSection.className = 'gifts-section';
                        
                        const giftsTitle = document.createElement('div');
                        giftsTitle.className = 'gifts-title';
                        giftsTitle.textContent = 'Select Gifts (once per army):';
                        
                        giftsSection.appendChild(giftsTitle);
                        
                        const checkboxGroup = document.createElement('div');
                        checkboxGroup.className = 'checkbox-group';
                        
                        Object.entries(GIFTS_OF_CHAOS).forEach(([name, data]) => {
                            const checkboxLabel = document.createElement('label');
                            checkboxLabel.className = 'checkbox-label';
                            
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.checked = unit.options.gifts.includes(name);
                            checkbox.disabled = usedGifts.has(name) && !unit.options.gifts.includes(name);
                            checkbox.onchange = (e) => {
                                if (e.target.checked) {
                                    unit.options.gifts.push(name);
                                    usedGifts.add(name);
                                } else {
                                    unit.options.gifts = unit.options.gifts.filter(g => g !== name);
                                    usedGifts.delete(name);
                                }
                                renderArmy();
                                updateSummary();
                            };
                            
                            const text = document.createTextNode(` ${name} (${data.cost}pts) - ${data.effect}`);
                            
                            checkboxLabel.appendChild(checkbox);
                            checkboxLabel.appendChild(text);
                            checkboxGroup.appendChild(checkboxLabel);
                        });
                        
                        giftsSection.appendChild(checkboxGroup);
                        
                        const warning = document.createElement('div');
                        warning.className = 'gift-warning';
                        warning.textContent = '⚠ Each gift can only be taken once per army';
                        giftsSection.appendChild(warning);
                        
                        giftsGroup.appendChild(label);
                        giftsGroup.appendChild(giftsSection);
                        controls.appendChild(giftsGroup);
                    }
                    
                    // Magic/Arcane Items Budget
                    if (unit.data.options?.magicItems || unit.data.options?.arcaneItems) {
                        const budgetGroup = document.createElement('div');
                        budgetGroup.className = 'control-group';
                        
                        const label = document.createElement('div');
                        label.className = 'control-label';
                        label.textContent = unit.data.options.arcaneItems ? 'Arcane Items:' : 'Magic Items:';
                        
                        const budgetDiv = document.createElement('div');
                        budgetDiv.className = 'magic-budget';
                        
                        const allowance = unit.data.options.magicItems || unit.data.options.arcaneItems;
                        const spent = 0; // Placeholder - would track actual item costs
                        
                        const budgetRow = document.createElement('div');
                        budgetRow.className = 'budget-row';
                        budgetRow.innerHTML = `
                            <span>Allowance:</span>
                            <span>${allowance} pts</span>
                        `;
                        
                        const remainingRow = document.createElement('div');
                        remainingRow.className = 'budget-row';
                        const remaining = allowance - spent;
                        remainingRow.innerHTML = `
                            <span>Remaining:</span>
                            <span class="${remaining >= 0 ? 'budget-remaining' : 'budget-exceeded'}">${remaining} pts</span>
                        `;
                        
                        budgetDiv.appendChild(budgetRow);
                        budgetDiv.appendChild(remainingRow);
                        
                        budgetGroup.appendChild(label);
                        budgetGroup.appendChild(budgetDiv);
                        controls.appendChild(budgetGroup);
                    }
                    
                    // Command
                    if (unit.data.options?.command && unit.data.options.command.length > 0) {
                        const commandGroup = document.createElement('div');
                        commandGroup.className = 'control-group';
                        
                        const label = document.createElement('div');
                        label.className = 'control-label';
                        label.textContent = 'Command:';
                        
                        const checkboxGroup = document.createElement('div');
                        checkboxGroup.className = 'checkbox-group';
                        
                        unit.data.options.command.forEach(cmd => {
                            const checkboxLabel = document.createElement('label');
                            checkboxLabel.className = 'checkbox-label';
                            
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.checked = unit.options.command.includes(cmd.name);
                            checkbox.onchange = (e) => {
                                if (e.target.checked) {
                                    unit.options.command.push(cmd.name);
                                } else {
                                    unit.options.command = unit.options.command.filter(c => c !== cmd.name);
                                }
                                renderArmy();
                                updateSummary();
                            };
                            
                            const text = document.createTextNode(` ${cmd.name} (${cmd.cost}pts)`);
                            
                            checkboxLabel.appendChild(checkbox);
                            checkboxLabel.appendChild(text);
                            checkboxGroup.appendChild(checkboxLabel);
                        });
                        
                        commandGroup.appendChild(label);
                        commandGroup.appendChild(checkboxGroup);
                        controls.appendChild(commandGroup);
                    }
                    
                    // Per-model equipment
                    if (unit.size > 1 && (
                        (unit.data.options?.weapons && unit.data.options.weapons.some(w => w.perModel)) ||
                        (unit.data.options?.armor && unit.data.options.armor.some(a => a.perModel)) ||
                        (unit.data.options?.upgrades && unit.data.options.upgrades.some(u => u.perModel))
                    )) {
                        const perModelDiv = document.createElement('div');
                        perModelDiv.className = 'per-model-equipment';
                        
                        const title = document.createElement('div');
                        title.className = 'per-model-title';
                        title.textContent = 'Individual Model Equipment:';
                        perModelDiv.appendChild(title);
                        
                        for (let i = 1; i <= unit.size; i++) {
                            const modelRow = document.createElement('div');
                            modelRow.className = 'model-row';
                            
                            const modelNum = document.createElement('span');
                            modelNum.className = 'model-number';
                            modelNum.textContent = `Model ${i}:`;
                            modelRow.appendChild(modelNum);
                            
                            const modelEqDiv = document.createElement('div');
                            modelEqDiv.className = 'model-equipment';
                            
                            // Weapons
                            if (unit.data.options?.weapons) {
                                unit.data.options.weapons.filter(w => w.perModel).forEach(weapon => {
                                    const checkboxLabel = document.createElement('label');
                                    checkboxLabel.className = 'checkbox-label';
                                    checkboxLabel.style.fontSize = '0.85em';
                                    
                                    const checkbox = document.createElement('input');
                                    checkbox.type = 'checkbox';
                                    checkbox.checked = unit.options.modelEquipment[i]?.weapons?.includes(weapon.name);
                                    checkbox.onchange = (e) => {
                                        if (!unit.options.modelEquipment[i]) {
                                            unit.options.modelEquipment[i] = { weapons: [], armor: [], upgrades: [] };
                                        }
                                        if (e.target.checked) {
                                            unit.options.modelEquipment[i].weapons.push(weapon.name);
                                        } else {
                                            unit.options.modelEquipment[i].weapons = 
                                                unit.options.modelEquipment[i].weapons.filter(w => w !== weapon.name);
                                        }
                                        renderArmy();
                                        updateSummary();
                                    };
                                    
                                    const text = document.createTextNode(` ${weapon.name} (${weapon.cost}pts)`);
                                    
                                    checkboxLabel.appendChild(checkbox);
                                    checkboxLabel.appendChild(text);
                                    modelEqDiv.appendChild(checkboxLabel);
                                });
                            }
                            
                            // Armor
                            if (unit.data.options?.armor) {
                                unit.data.options.armor.filter(a => a.perModel).forEach(armor => {
                                    const checkboxLabel = document.createElement('label');
                                    checkboxLabel.className = 'checkbox-label';
                                    checkboxLabel.style.fontSize = '0.85em';
                                    
                                    const checkbox = document.createElement('input');
                                    checkbox.type = 'checkbox';
                                    checkbox.checked = unit.options.modelEquipment[i]?.armor?.includes(armor.name);
                                    checkbox.onchange = (e) => {
                                        if (!unit.options.modelEquipment[i]) {
                                            unit.options.modelEquipment[i] = { weapons: [], armor: [], upgrades: [] };
                                        }
                                        if (e.target.checked) {
                                            unit.options.modelEquipment[i].armor.push(armor.name);
                                        } else {
                                            unit.options.modelEquipment[i].armor = 
                                                unit.options.modelEquipment[i].armor.filter(a => a !== armor.name);
                                        }
                                        renderArmy();
                                        updateSummary();
                                    };
                                    
                                    const text = document.createTextNode(` ${armor.name} (${armor.cost}pts)`);
                                    
                                    checkboxLabel.appendChild(checkbox);
                                    checkboxLabel.appendChild(text);
                                    modelEqDiv.appendChild(checkboxLabel);
                                });
                            }
                            
                            // Upgrades
                            if (unit.data.options?.upgrades) {
                                unit.data.options.upgrades.filter(u => u.perModel).forEach(upgrade => {
                                    const checkboxLabel = document.createElement('label');
                                    checkboxLabel.className = 'checkbox-label';
                                    checkboxLabel.style.fontSize = '0.85em';
                                    
                                    const checkbox = document.createElement('input');
                                    checkbox.type = 'checkbox';
                                    checkbox.checked = unit.options.modelEquipment[i]?.upgrades?.includes(upgrade.name);
                                    checkbox.onchange = (e) => {
                                        if (!unit.options.modelEquipment[i]) {
                                            unit.options.modelEquipment[i] = { weapons: [], armor: [], upgrades: [] };
                                        }
                                        if (e.target.checked) {
                                            unit.options.modelEquipment[i].upgrades.push(upgrade.name);
                                        } else {
                                            unit.options.modelEquipment[i].upgrades = 
                                                unit.options.modelEquipment[i].upgrades.filter(u => u !== upgrade.name);
                                        }
                                        renderArmy();
                                        updateSummary();
                                    };
                                    
                                    const text = document.createTextNode(` ${upgrade.name} (${upgrade.cost}pts)`);
                                    
                                    checkboxLabel.appendChild(checkbox);
                                    checkboxLabel.appendChild(text);
                                    modelEqDiv.appendChild(checkboxLabel);
                                });
                            }
                            
                            modelRow.appendChild(modelEqDiv);
                            perModelDiv.appendChild(modelRow);
                        }
                        
                        controls.appendChild(perModelDiv);
                    }
                    
                    // Special rules with tooltips
                    const rulesDiv = document.createElement('div');
                    rulesDiv.className = 'special-rules';
                    
                    const rulesTitle = document.createElement('div');
                    rulesTitle.className = 'special-rules-title';
                    rulesTitle.textContent = 'Special Rules:';
                    
                    rulesDiv.appendChild(rulesTitle);
                    
                    unit.data.specialRules.forEach(rule => {
                        const tag = document.createElement('span');
                        tag.className = 'rule-tag';
                        tag.textContent = rule;
                        if (SPECIAL_RULE_TOOLTIPS[rule]) {
                            tag.setAttribute('data-tooltip', SPECIAL_RULE_TOOLTIPS[rule]);
                        }
                        rulesDiv.appendChild(tag);
                    });
                    
                    if (unit.options.mark && unit.options.mark !== 'Undivided') {
                        const markTag = document.createElement('span');
                        markTag.className = 'rule-tag';
                        markTag.textContent = MARKS_OF_CHAOS[unit.options.mark].rules;
                        markTag.style.background = 'rgba(139, 0, 0, 0.5)';
                        
                        const markRules = MARKS_OF_CHAOS[unit.options.mark].rules.split(', ');
                        const tooltips = markRules.map(r => SPECIAL_RULE_TOOLTIPS[r]).filter(t => t);
                        if (tooltips.length > 0) {
                            markTag.setAttribute('data-tooltip', tooltips.join(' | '));
                        }
                        
                        rulesDiv.appendChild(markTag);
                    }
                    
                    if (unit.options.formation) {
                        const formTag = document.createElement('span');
                        formTag.className = 'rule-tag';
                        formTag.textContent = unit.options.formation;
                        formTag.style.background = 'rgba(69, 139, 19, 0.5)';
                        if (SPECIAL_RULE_TOOLTIPS[unit.options.formation]) {
                            formTag.setAttribute('data-tooltip', SPECIAL_RULE_TOOLTIPS[unit.options.formation]);
                        }
                        rulesDiv.appendChild(formTag);
                    }
                    
                    unitDiv.appendChild(header);
                    unitDiv.appendChild(controls);
                    unitDiv.appendChild(rulesDiv);
                    armyList.appendChild(unitDiv);
                });
            });
            
            if (!hasUnits) {
                armyList.innerHTML = '<p style="text-align: center; color: #a67c52; padding: 40px;">Click units from the left panel to add them to your army</p>';
            }
        }

        function updateSummary() {
            let totals = {
                lords: 0,
                heroes: 0,
                core: 0,
                special: 0,
                rare: 0
            };
            
            Object.entries(army).forEach(([category, units]) => {
                units.forEach(unit => {
                    totals[category] += calculateUnitCost(unit);
                });
            });
            
            document.getElementById('lords-points').textContent = `${totals.lords} pts`;
            document.getElementById('heroes-points').textContent = `${totals.heroes} pts`;
            document.getElementById('core-points').textContent = `${totals.core} pts`;
            document.getElementById('special-points').textContent = `${totals.special} pts`;
            document.getElementById('rare-points').textContent = `${totals.rare} pts`;
            
            const total = Object.values(totals).reduce((a, b) => a + b, 0);
            document.getElementById('total-points').textContent = `${total} pts`;
            
            // Update gifts used display
            const giftsSection = document.getElementById('gifts-used');
            const giftsList = document.getElementById('gifts-list');
            
            if (usedGifts.size > 0) {
                giftsSection.style.display = 'block';
                giftsList.innerHTML = Array.from(usedGifts).map(gift => 
                    `<div>• ${gift} (${GIFTS_OF_CHAOS[gift].cost}pts)</div>`
                ).join('');
            } else {
                giftsSection.style.display = 'none';
            }
        }

        function exportList() {
            let text = '═══════════════════════════════════════\n';
            text += '  BEASTMEN BRAYHERDS ARMY LIST\n';
            text += '  Homebrew Edition\n';
            text += '═══════════════════════════════════════\n\n';
            
            const categories = [
                ['LORDS', 'lords'],
                ['HEROES', 'heroes'],
                ['CORE', 'core'],
                ['SPECIAL', 'special'],
                ['RARE', 'rare']
            ];
            
            categories.forEach(([title, key]) => {
                if (army[key].length > 0) {
                    text += `═══ ${title} ═══\n\n`;
                    
                    army[key].forEach(unit => {
                        const cost = calculateUnitCost(unit);
                        text += `${unit.name}${unit.size > 1 ? ` (${unit.size})` : ''} - ${cost} pts\n`;
                        
                        if (unit.options.formation) {
                            text += `  Formation: ${unit.options.formation}\n`;
                        }
                        
                        if (unit.options.mark !== 'Undivided') {
                            text += `  Mark: ${unit.options.mark}\n`;
                        }
                        
                        if (unit.options.command.length > 0) {
                            text += `  Command: ${unit.options.command.join(', ')}\n`;
                        }
                        
                        if (unit.options.gifts.length > 0) {
                            text += `  Gifts: ${unit.options.gifts.join(', ')}\n`;
                        }
                        
                        // Per-model equipment summary
                        if (unit.options.modelEquipment && Object.keys(unit.options.modelEquipment).length > 0) {
                            const equipmentCounts = {};
                            Object.values(unit.options.modelEquipment).forEach(modelEq => {
                                const allEq = [...(modelEq.weapons || []), ...(modelEq.armor || []), ...(modelEq.upgrades || [])];
                                allEq.forEach(eq => {
                                    equipmentCounts[eq] = (equipmentCounts[eq] || 0) + 1;
                                });
                            });
                            
                            Object.entries(equipmentCounts).forEach(([eq, count]) => {
                                text += `  ${count}x ${eq}\n`;
                            });
                        }
                        
                        text += '\n';
                    });
                }
            });
            
            let totals = {
                lords: 0,
                heroes: 0,
                core: 0,
                special: 0,
                rare: 0
            };
            
            Object.entries(army).forEach(([category, units]) => {
                units.forEach(unit => {
                    totals[category] += calculateUnitCost(unit);
                });
            });
            
            const total = Object.values(totals).reduce((a, b) => a + b, 0);
            
            text += '═══════════════════════════════════════\n';
            text += `Lords: ${totals.lords} pts\n`;
            text += `Heroes: ${totals.heroes} pts\n`;
            text += `Core: ${totals.core} pts\n`;
            text += `Special: ${totals.special} pts\n`;
            text += `Rare: ${totals.rare} pts\n`;
            text += `\nTOTAL: ${total} pts\n`;
            text += '═══════════════════════════════════════\n';
            
            navigator.clipboard.writeText(text).then(() => {
                alert('Army list copied to clipboard!');
            });
        }

        function clearArmy() {
            if (confirm('Are you sure you want to clear your entire army?')) {
                army = {
                    lords: [],
                    heroes: [],
                    core: [],
                    special: [],
                    rare: []
                };
                usedGifts.clear();
                renderArmy();
                updateSummary();
            }
        }

        window.onload = init;
    </script>
</body>
</html>
```
